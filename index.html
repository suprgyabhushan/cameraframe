<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Smart Device Camera Template for HTML, CSS, JS and WebRTC">
  <meta name="keywords" content="HTML,CSS,JavaScript, WebRTC, Camera">
  <meta name="author" content="Kasper Kamperman">
  <title>Camera Frame</title>
  <script type="text/javascript" src="js/clmtrackr.js"></script>
  <!-- Load TensorFlow.js -->
  <script src="https://unpkg.com/@tensorflow/tfjs"></script>
  <!-- Load Posenet -->
  <script src="https://unpkg.com/@tensorflow-models/posenet">
  </script>

  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <div id="container">
    <div id="vid_container">
        
        <video id="video" width="320" height="240" autoplay playsinline></video>
        <canvas id="camerasensor" width="320" height="240"></canvas>
        <canvas id="cameramotion" width="160" height="200"></canvas>
        <canvas id="eyes" width="50" height="25"></canvas>
        <style>
        #eyes
        {
            position: absolute;
            top: 0;
            right: 0;
        }
        </style>
        
        
        
        <div id="video_overlay"></div>
    </div>
    <div id="gui_controls">
        
        <button id="switchCameraButton" name="switch Camera" type="button" aria-pressed="false"></button>
        <!--<button id="takePhotoButton" name="take Photo" type="button">	</button>-->
        <button id="toggleFullScreenButton" name="toggle FullScreen" type="button" aria-pressed="false"></button>
        <button id="startFaceTrackingButton" name=" start FaceTracking" type="button" onclick="start()"></button>
        <!--<img src="//:0" alt="" id="cameraoutput">-->
    </div>
  </div> 
  <script src="js/DetectRTC.min.js"></script>
  <script src="js/adapter.min.js"></script>  
  <script src="js/screenfull.min.js"></script>
  <script src="js/howler.core.min.js"></script>
  <script src="js/main.js"></script>
 
  <script src="js/creative_coding.js"></script>
  <script type="text/javascript">
    var video = document.getElementById('video');
    var w = video.width;
    var w1 = w/2;
    var h = video.height;
    var overlay = document.getElementById('camerasensor');
    var ctx = overlay.getContext('2d');
    //var blendoverlay = document.getElementById('camerablend');
    //var blendcontext = blend.getContext('2d'); 
    
    
    
      
    var ctrack = new clm.tracker();
    ctrack.init();
    var trackingStarted = false;

    function start() {
    video.play();
    ctrack.start(video);
    trackingStarted = true;
    drawLoop();
    }
 
    
    function drawLoop() {    
        requestAnimationFrame(drawLoop);
        ctx.clearRect(0, 0, w, h);
        if (ctrack.getCurrentPosition()) {
        ctrack.draw(overlay);
        const eyesRect = getEyesRectangle(ctrack.getCurrentPosition());
        ctx.strokeStyle = 'red';
        ctx.strokeRect(eyesRect[0], eyesRect[1], eyesRect[2], eyesRect[3]);

        // The video might internally have a different size, so we need these
        // factors to rescale the eyes rectangle before cropping:
        const resizeFactorX = video.videoWidth / video.width;
        const resizeFactorY = video.videoHeight / video.height;

        // Crop the eyes from the video and paste them in the eyes canvas:
        const eyesCanvas = $('#eyes')[0];
        const eyesCC = eyesCanvas.getContext('2d');

        eyesCC.drawImage(
        video,
        eyesRect[0] * resizeFactorX, eyesRect[1] * resizeFactorY,
        eyesRect[2] * resizeFactorX, eyesRect[3] * resizeFactorY,
        0, 0, eyesCanvas.width, eyesCanvas.height
        );
        }
    }

    function getEyesRectangle(positions) {
    const minX = positions[23][0] - 5;
    const maxX = positions[28][0] + 5;
    const minY = positions[24][1] - 5;
    const maxY = positions[26][1] + 5;

    const width = maxX - minX;
    const height = maxY - minY;

    return [minX, minY, width, height];
    }
    //var scalefactor = 40;
    /*var previous_frame = [];
    var threshold = 50;
    var sample_size = 50;
    function motionDetection()
    {
        var motion = [];
        ctx.drawImage(video, 0, 0, w, h);    
        var data = ctx.getImageData(0, 0, w, h).data;
        console.log(data);
        //ctx.background(0);    
        for (var y = 0; y < h; y+= sample_size)
        {

            for (var x = 0; x < w; x+= sample_size)
            {
                var pos = (x + y * w) * 4;
                var r = data[pos];
                var g = data[pos+1];
                var b = data[pos+2];

                if(previous_frame[pos] && Math.abs(previous_frame[pos] - r) > threshold)
                {
                    //ctx.fillStyle = 'rgb(r, g, b)';
                    //ctx.fillRect(x, y, 40, 40);
                    motion.push({x: x, y: y, r: r, g: g, b: b});
                    //ctx.fillStyle = 'rgb(r, g, b)';
                    //ctx.fillRect(x, y, sample_size, sample_size);
                }
                previous_frame[pos] = r;
            }
        }
        return motion;
    }

    function draw()
    {

        //ctx.background(250);
        var motion = motionDetection();
        for (i = 0; i < motion.length; i++)
        {
            var m = motion[i];
            ctx.fillStyle = 'rgb(m.r, m.g, m.b)';
            ctx.fillEllipse(m.x, m.y, sample_size, sample_size);
        }
    }*/
    
    function draw1()
    {

        ctx.drawImage(video, 150, 0, 900, 1500, 0, 0, 850, 850);    
    }

  


  </script>

  

  
  
</body>
</html>
